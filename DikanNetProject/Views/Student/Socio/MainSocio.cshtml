@using DataEntities;

@{
    ViewBag.Title = "סוציואקונומית";
    Layout = "~/Views/Student/_Sp_Layout.cshtml";
}
<h2>מלגת סוציואקונומית</h2>

<input id="spid" value="@ViewBag.SpId" hidden />

<div id="msform">
    <!-- progressbar -->
    <ul id="progressbar">
        <li class="active">פרטים אישיים - הרחבה</li>
        <li>הכנסות סטודנט</li>
        <li>מקורות מימון</li>
        <li>רכבים</li>
    </ul>
    <!-- fieldsets -->
    <fieldset>
        @using (Ajax.BeginForm("SaveSocioDetails", "Student", new AjaxOptions { HttpMethod = "POST", OnSuccess = "sociodetsuccess", OnFailure = "sociodetfail", OnBegin = "loadingajax", OnComplete = "completeajax" }, new { enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()
            <div id="partialsocio">
                @Html.Action("PartialSocioDetails", "Student", new { SpId = ViewBag.SpId })
            </div>
            <button class="btn btn-primary" id="sociodetsub">המשך</button>
        }
        <input id="sociodetnext" type="button" name="next" class="next action-button" value="Next" />
    </fieldset>
    <fieldset>
        @using (Ajax.BeginForm("StudentFinance", "Student", new AjaxOptions { HttpMethod = "POST", OnSuccess = "secondsuccess();" }))
        {
            @Html.AntiForgeryToken()
            <div id="partialstudfinance">
            </div>
        }
        <input type="button" name="previous" class="previous action-button" value="Previous" />
        <input type="button" name="next" class="next action-button" value="Next" />
    </fieldset>
    <fieldset>
        @Html.AntiForgeryToken()
        <div id="partialfundings">
            @Html.Action("PartialFundings", "Student")
        </div>
        <input type="button" name="previous" class="previous action-button" value="Previous" />
        <input type="button" name="next" class="next action-button" value="Next" />
    </fieldset>    
    <fieldset>
        @Html.AntiForgeryToken()
        <div id="partialcars">
            @Html.Action("PartialCars", "Student")
        </div>
        <input type="button" name="previous" class="previous action-button" value="Previous" />
        <input type="button" name="next" class="next action-button" value="Next" />
    </fieldset>
</div>

<!-- Loading Modal -->
<div class="modal" id="loadingmodal" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title m-auto">אנא המתן</h2>
            </div>

            <!-- body - loading spinner -->
            <div class="modal-body text-center">
                <img src="@Url.Content("~/Content/Pic/Spinner.gif")" alt="" />
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        $(document).ready(function () {

            /*$('#sociodetsub').click(function () {
                var form = $("Form#partialsocio");

                $.ajax({
                    url: 'Url.Action("SaveSocioDetails", "Student")',
                    data: form.serialize(),
                    type: 'POST',
                    success: function (data) {
                        console.log(data);
                                    $('#partialsocio').html("");
            $('#partialsocio').html(data);
                    }
                });
            });*/
        });


        function loadingajax() { // loading modal - show spinner
            $('#loadingmodal').modal('show');
        }

        function completeajax() { // loading modal - dismiss spinner
            $('#loadingmodal').modal('hide');
        }

        function sociodetsuccess(bdata) { // if ajax return success
            console.log('this is ajaxSuccess');
            $('#partialsocio').empty(); // empty the div of sociodet
            $('#partialsocio').html(bdata); // show partial view that have returned - if the user will click previous
            var workst = $('input[name=WorkSt]:checked').val(); // get work status for student finance
            getstudentfinancepartial(workst);
            $("#sociodetnext").click();
        }

        function sociodetfail(bdata) { // if ajax return failed
            console.log('this is ajaxfail');
            $('#partialsocio').empty(); // empty the div of sociodet
            $('#partialsocio').html(bdata.responseText); // show partial view that have returned - with errors
        }

        function getstudentfinancepartial(workst) {
             $.ajax({
                    url: '@Url.Action("PartialStudentFinance", "Student")',
                    type: 'GET',
                    data: { WorkSt: workst},
                    success: function (data) {
                        console.log("get student finance");
                        $('#partialstudfinance').empty();
                        $('#partialstudfinance').html(data);
                    }
            });
        }
    </script>
}
